generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/* ================= ENUM ================= */
enum DocumentType {
  SD
  WORK_ORDER
  TENDER
}

/* ================= DEPARTMENT =================
   âœ” Master table
   âœ” Will be seeded (WRD, PHED, JJM, CGMSC)
================================================ */
model Department {
  id        String   @id @default(cuid())
  name      String   @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sites     Site[]
}

/* ================= SITE ================= */
model Site {
  id           String      @id @default(cuid())
  siteName     String
  tenderNo     String?
  sdAmount     Decimal?    @db.Decimal(18,2)

  // ðŸ”‘ Department relation (optional but FK-safe)
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  estimate     SiteEstimate?
  documents    SiteDocument[]

  isDeleted    Boolean     @default(false)

  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([departmentId])
  @@index([isDeleted])
}

/* ================= SITE ESTIMATE =================
   âœ” One-to-one with Site
   âœ” Cascades on Site delete
================================================ */
model SiteEstimate {
  id        String   @id @default(cuid())
  siteId    String   @unique
  site      Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Concrete
  cement    Decimal? @db.Decimal(18,2)
  metal     Decimal? @db.Decimal(18,2)
  sand      Decimal? @db.Decimal(18,2)
  labour    Decimal? @db.Decimal(18,2)
  royalty   Decimal? @db.Decimal(18,2)
  overhead  Decimal? @db.Decimal(18,2)

  // CNS
  lead              Decimal? @db.Decimal(18,2)
  dressing          Decimal? @db.Decimal(18,2)
  waterCompaction   Decimal? @db.Decimal(18,2)
  loading           Decimal? @db.Decimal(18,2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/* ================= SITE DOCUMENT =================
   âœ” Cloudinary-based storage
   âœ” SD & WORK_ORDER unique per site
   âœ” TENDER multiple allowed
================================================ */
model SiteDocument {
  id           String       @id @default(cuid())
  siteId       String
  site         Site         @relation(fields: [siteId], references: [id], onDelete: Cascade)

  type         DocumentType
  url          String?
  secureUrl    String
  publicId     String
  resourceType String
  bytes        Int?
  format       String?
  originalName String?

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([siteId, type])
  @@unique([siteId, type], map: "uniq_site_single_docs")
}
