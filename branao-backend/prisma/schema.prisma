generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/// /////////////////////////////////////////////
/// ================= DEPARTMENT =================
/// /////////////////////////////////////////////
model Department {
  id        String    @id @default(cuid())
  name      String    @unique
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  sites     Site[]
  vouchers  Voucher[]

  @@index([isDeleted])
}

/// /////////////////////////////////////////////
/// ================= SITE =================
/// /////////////////////////////////////////////
model Site {
  id                      String                   @id @default(cuid())
  siteName                String
  tenderNo                String?
  sdAmount                Decimal?                 @db.Decimal(18, 2)
  status                  SiteStatus               @default(NOT_STARTED)
  departmentId            String?
  isDeleted               Boolean                  @default(false)
  deletedAt               DateTime?
  deletedBy               String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  ledgers                 Ledger[]
  materialSupplierLedgers MaterialSupplierLedger[] @relation("SiteMaterialSupplierLedgers")
  department              Department?              @relation(fields: [departmentId], references: [id])
  documents               SiteDocument[]
  estimate                SiteEstimate?
  expenses                SiteExpense[]
  receipts                SiteReceipt[]
  siteTransactions        SiteTransaction[]
  staffExpenses           StaffExpense[]
  vouchers                Voucher[]

  @@index([departmentId])
  @@index([status])
  @@index([isDeleted])
}

/// /////////////////////////////////////////////
/// ================= SITE ESTIMATE =================
/// /////////////////////////////////////////////
model SiteEstimate {
  id              String   @id @default(cuid())
  siteId          String   @unique
  cement          Decimal? @db.Decimal(18, 2)
  metal           Decimal? @db.Decimal(18, 2)
  sand            Decimal? @db.Decimal(18, 2)
  labour          Decimal? @db.Decimal(18, 2)
  royalty         Decimal? @db.Decimal(18, 2)
  overhead        Decimal? @db.Decimal(18, 2)
  lead            Decimal? @db.Decimal(18, 2)
  dressing        Decimal? @db.Decimal(18, 2)
  waterCompaction Decimal? @db.Decimal(18, 2)
  loading         Decimal? @db.Decimal(18, 2)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  site            Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)
}

/// /////////////////////////////////////////////
/// ================= SITE DOCUMENT =================
/// /////////////////////////////////////////////
model SiteDocument {
  id           String       @id @default(cuid())
  siteId       String
  type         DocumentType
  url          String?
  secureUrl    String
  publicId     String
  resourceType String
  bytes        Int?
  format       String?
  originalName String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  site         Site         @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([siteId, type], map: "uniq_site_single_docs")
  @@index([siteId, type])
}

/// /////////////////////////////////////////////
/// ================= SITE EXPENSE =================
/// /////////////////////////////////////////////
model SiteExpense {
  id             String        @id @default(cuid())
  siteId         String
  expenseDate    DateTime
  expenseTitle   String
  summary        String
  paymentDetails String?
  amount         Decimal       @db.Decimal(18, 2)
  staffExpenseId String?       @unique
  isDeleted      Boolean       @default(false)
  deletedAt      DateTime?
  deletedBy      String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  site           Site          @relation(fields: [siteId], references: [id], onDelete: Cascade)
  staffExpense   StaffExpense? @relation("StaffExpenseToSiteExpense", fields: [staffExpenseId], references: [id])

  @@index([siteId])
  @@index([expenseDate])
  @@index([isDeleted])
  @@index([staffExpenseId])
}

/// /////////////////////////////////////////////
/// ================= SITE RECEIPT =================
/// ðŸ”¥ AMT RECEIVED (PROFIT MODULE)
/// /////////////////////////////////////////////
model SiteReceipt {
  id           String    @id @default(cuid())
  siteId       String
  receiptDate  DateTime
  referenceNo  String?
  receivedFrom String?
  paymentMode  String?
  amount       Decimal   @db.Decimal(18, 2)
  remarks      String?
  isDeleted    Boolean   @default(false)
  deletedAt    DateTime?
  deletedBy    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  site         Site      @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId])
  @@index([receiptDate])
  @@index([isDeleted])
}

/// /////////////////////////////////////////////
/// ================= AUDIT LOG (GLOBAL) =================
/// /////////////////////////////////////////////
model AuditLog {
  id        String      @id @default(cuid())
  userId    String?
  module    String
  recordId  String
  action    AuditAction
  oldData   Json?
  newData   Json?
  ip        String?
  userAgent String?
  createdAt DateTime    @default(now())

  @@index([module])
  @@index([recordId])
  @@index([action])
}

/// /////////////////////////////////////////////
/// =============== VOUCHER ====================
/// /////////////////////////////////////////////
model Voucher {
  id                   String     @id @default(cuid())
  voucherDate          DateTime
  siteId               String
  departmentId         String
  grossAmt             Decimal?   @db.Decimal(18, 2)
  withheld             Decimal?   @db.Decimal(18, 2)
  incomeTax            Decimal?   @db.Decimal(18, 2)
  revenue              Decimal?   @db.Decimal(18, 2)
  lwf                  Decimal?   @db.Decimal(18, 2)
  royalty              Decimal?   @db.Decimal(18, 2)
  miscDeduction        Decimal?   @db.Decimal(18, 2)
  karmkarTax           Decimal?   @db.Decimal(18, 2)
  securedDeposit       Decimal?   @db.Decimal(18, 2)
  tdsOnGst             Decimal?   @db.Decimal(18, 2)
  tds                  Decimal?   @db.Decimal(18, 2)
  performanceGuarantee Decimal?   @db.Decimal(18, 2)
  gst                  Decimal?   @db.Decimal(18, 2)
  improperFinishing    Decimal?   @db.Decimal(18, 2)
  otherDeduction       Decimal?   @db.Decimal(18, 2)
  deductionAmt         Decimal?   @db.Decimal(18, 2)
  chequeAmt            Decimal    @db.Decimal(18, 2)
  voucherFileUrl       String?
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
  department           Department @relation(fields: [departmentId], references: [id])
  site                 Site       @relation(fields: [siteId], references: [id])

  @@index([siteId])
  @@index([departmentId])
}

/// /////////////////////////////////////////////
/// ============== LEDGER TYPE ================
/// /////////////////////////////////////////////
model LedgerType {
  id        String    @id @default(cuid())
  name      String    @unique
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  ledgers   Ledger[]

  @@index([isDeleted])
}

/// /////////////////////////////////////////////
/// ================= LEDGER ==================
/// /////////////////////////////////////////////
model Ledger {
  id                      String                   @id @default(cuid())
  ledgerTypeId            String
  siteId                  String?
  name                    String
  address                 String?
  mobile                  String?
  openingBalance          Decimal?                 @db.Decimal(18, 2)
  closingBalance          Decimal?                 @db.Decimal(18, 2)
  remark                  String?
  isDeleted               Boolean                  @default(false)
  deletedAt               DateTime?
  deletedBy               String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  ledgerType              LedgerType               @relation(fields: [ledgerTypeId], references: [id])
  site                    Site?                    @relation(fields: [siteId], references: [id])
  materialSupplierLedgers MaterialSupplierLedger[] @relation("LedgerMaterialSupplierLedgers")
  paymentEntries          PaymentEntry[]
  staffExpenses           StaffExpense[]

  @@index([ledgerTypeId])
  @@index([siteId])
  @@index([isDeleted])
}

/// /////////////////////////////////////////////
/// =============== STAFF EXPENSE ==============
/// /////////////////////////////////////////////
model StaffExpense {
  id            String       @id @default(cuid())
  staffLedgerId String
  siteId        String?
  expenseDate   DateTime
  expenseTitle  String
  summary       String?
  remark        String?
  outAmount     Decimal?     @db.Decimal(18, 2)
  inAmount      Decimal?     @db.Decimal(18, 2)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  siteExpense   SiteExpense? @relation("StaffExpenseToSiteExpense")
  site          Site?        @relation(fields: [siteId], references: [id])
  staffLedger   Ledger       @relation(fields: [staffLedgerId], references: [id])

  @@index([siteId], map: "StaffExpense_siteId_fkey")
  @@index([staffLedgerId], map: "StaffExpense_staffLedgerId_fkey")
}

/// /////////////////////////////////////////////
/// ============ MATERIAL SUPPLIER LEDGER (TRANSACTIONS) ============
/// /////////////////////////////////////////////
model MaterialSupplierLedger {
  id           String   @id @default(cuid())
  entryDate    DateTime
  receiptNo    String?
  parchiPhoto  String?  @db.Text
  otp          String?
  vehicleNo    String?
  vehiclePhoto String?  @db.Text
  material     String
  size         String?
  qty          Decimal  @db.Decimal(12, 3)
  rate         Decimal  @db.Decimal(12, 2)
  royaltyQty   Decimal? @db.Decimal(12, 3)
  royaltyRate  Decimal? @db.Decimal(12, 2)
  royaltyAmt   Decimal? @db.Decimal(12, 2)
  gstPercent   Decimal? @db.Decimal(5, 2)
  taxAmt       Decimal? @db.Decimal(12, 2)
  totalAmt     Decimal? @db.Decimal(12, 2)
  paymentAmt   Decimal? @db.Decimal(12, 2)
  balanceAmt   Decimal? @db.Decimal(12, 2)
  remarks      String?
  ledgerId     String
  siteId       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  ledger       Ledger   @relation("LedgerMaterialSupplierLedgers", fields: [ledgerId], references: [id])
  site         Site?    @relation("SiteMaterialSupplierLedgers", fields: [siteId], references: [id])

  @@index([ledgerId])
  @@index([siteId])
  @@index([entryDate])
}

/// /////////////////////////////////////////////
/// =============== MATERIAL MASTER ================
/// /////////////////////////////////////////////
model MaterialMaster {
  id        String    @id @default(cuid())
  name      String    @unique
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([isDeleted])
  @@index([name])
}

model SiteTransaction {
  id        String        @id @default(cuid())
  siteId    String
  txnDate   DateTime
  source    SiteTxnSource
  sourceId  String
  nature    SiteTxnNature
  amount    Decimal       @db.Decimal(18, 2)
  title     String?
  remarks   String?
  meta      Json?
  isDeleted Boolean       @default(false)
  deletedAt DateTime?
  deletedBy String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  site      Site          @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([source, sourceId])
  @@index([siteId])
  @@index([txnDate])
  @@index([siteId, txnDate])
  @@index([source, sourceId])
  @@index([isDeleted])
}

model PaymentEntry {
  id          String   @id @default(cuid())
  ledgerId    String
  entryDate   DateTime
  paymentMode String
  particulars String?
  amount      Decimal  @db.Decimal(18, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  ledger      Ledger   @relation(fields: [ledgerId], references: [id])

  @@index([ledgerId])
  @@index([entryDate])
}

/// /////////////////////////////////////////////
/// ================= ENUMS =================
/// /////////////////////////////////////////////
enum DocumentType {
  SD
  WORK_ORDER
  TENDER
}

enum SiteStatus {
  NOT_STARTED
  ONGOING
  COMPLETED
  ON_HOLD
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  RESTORE
  HARD_DELETE
}

/// /////////////////////////////////////////////
/// ============ SITE TRANSACTION (UNIFIED) ============
/// /////////////////////////////////////////////
enum SiteTxnSource {
  SITE_EXPENSE
  SITE_RECEIPT
  STAFF_EXPENSE
  MATERIAL_PURCHASE
  VOUCHER
}

enum SiteTxnNature {
  DEBIT
  CREDIT
}
